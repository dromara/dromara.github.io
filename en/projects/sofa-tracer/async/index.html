<!doctype html><html><head><title>Asynchronous thread processing · SOFAStack</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="SOFAStack is a Scalable Open Financial Architecture for building cloud native applications"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=https://gw.alipayobjects.com/os/q/cms/images/jqu9346l/4ba95631-2489-4885-881f-bc7f8d787d5e_w64_h61.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-142131411-1','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome SOFA</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-tracer/async/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome SOFA</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-tracer/async/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title="SOFATracer is a distributed link tracing system based on OpenTracing specification.">SOFATracer<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>Main Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-boot/overview>SOFABoot</a></li><li class=item><a href=/en/projects/sofa-rpc/overview>SOFARPC</a></li><li class=item><a href=/en/projects/sofa-tracer/overview>SOFATracer</a></li><li class=item><a href=/en/projects/sofa-lookout/overview>SOFALookout</a></li><li class=item><a href=/en/projects/sofa-registry/overview>SOFARegistry</a></li></ul></div><div class=toc-list><h4 class=title>Incubating Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-mesh/overview>SOFAMesh</a></li><li class=item><a href=/en/projects/sofa-dashboard/overview>SOFADashboard</a></li></ul></div><div class=toc-list><h4 class=title>Tool Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-bolt/overview>SOFABolt</a></li><li class=item><a href=/en/projects/sofa-jraft/overview>SOFAJRaft</a></li><li class=item><a href=/en/projects/sofa-acts/overview>SOFAActs</a></li><li class=item><a href=https://www.sofastack.tech/en/projects/sofa-boot/sofa-ark-readme/>SOFAArk</a></li></ul></div><div class=toc-list><h4 class=title>Ecosystem Projects</h4><ul class=list><li class=item><a href=https://mosn.io/en>MOSN</a></li><li class=item><a href=https://occlum.io>Occlum</a></li><li class=item><a href=https://seata.io>Seata</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title="SOFATracer overview" href=/en/projects/sofa-tracer/overview>SOFATracer overview</a></div></li><li class=item><div class=link><a title=Terminologies href=/en/projects/sofa-tracer/explanation>Terminologies</a></div></li><li class=item><div class=link><a title="TraceId and spanId generation rule" href=/en/projects/sofa-tracer/traceid-generated-rule>TraceId and spanId generation rule</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Quick start guide">Quick start guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Spring MVC Integration" href=/en/projects/sofa-tracer/usage-of-mvc>Spring MVC Integration</a></div></li><li class=item><div class=link><a title="HttpClient Integration" href=/en/projects/sofa-tracer/usage-of-httpclient>HttpClient Integration</a></div></li><li class=item><div class=link><a title="DataSource Integration" href=/en/projects/sofa-tracer/usage-of-datasource>DataSource Integration</a></div></li><li class=item><div class=link><a title="RestTemplate Integration" href=/en/projects/sofa-tracer/usage-of-resttemplate>RestTemplate Integration</a></div></li><li class=item><div class=link><a title="OkHttp Integration" href=/en/projects/sofa-tracer/usage-of-okhttp>OkHttp Integration</a></div></li><li class=item><div class=link><a title="Dubbo Integration" href=/en/projects/sofa-tracer/usage-of-dubbo>Dubbo Integration</a></div></li><li class=item><div class=link><a title="OpenFeign Integration" href=/en/projects/sofa-tracer/usage-of-openfeign>OpenFeign Integration</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=Features>Features</a></div><ul class=leaf-section><li class=item><div class=link><a title="Print traceId and spanId in application log" href=/en/projects/sofa-tracer/print-traceid-spanid>Print traceId and spanId in application log</a></div></li><li class=item><div class="link -current"><a title="Asynchronous thread processing" href=/en/projects/sofa-tracer/async>Asynchronous thread processing</a></div></li><li class=item><div class=link><a title="Sampling modes" href=/en/projects/sofa-tracer/sampler>Sampling modes</a></div></li><li class=item><div class=link><a title="Report data to Zipkin" href=/en/projects/sofa-tracer/report-to-zipkin>Report data to Zipkin</a></div></li></ul></li><li class=item><div class=link><a title="SOFATracer Tools" href=/en/projects/sofa-tracer/utils>SOFATracer Tools</a></div></li><li class=item><div class=link><a title="SOFATracer configuration items" href=/en/projects/sofa-tracer/configuration>SOFATracer configuration items</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Log format">Log format</a></div><ul class=leaf-section><li class=item><div class=link><a title="Spring MVC log" href=/en/projects/sofa-tracer/log-format-springmvc>Spring MVC log</a></div></li><li class=item><div class=link><a title="HttpClient log" href=/en/projects/sofa-tracer/log-format-httpclient>HttpClient log</a></div></li><li class=item><div class=link><a title="DataSource log" href=/en/projects/sofa-tracer/log-format-datasource>DataSource log</a></div></li><li class=item><div class=link><a title="SOFARPC log" href=/en/projects/sofa-tracer/log-format-sofarpc>SOFARPC log</a></div></li><li class=item><div class=link><a title="OkHttp log" href=/en/projects/sofa-tracer/log-format-okhttp>OkHttp log</a></div></li><li class=item><div class=link><a title="RestTemplate log" href=/en/projects/sofa-tracer/log-format-resttemplate>RestTemplate log</a></div></li><li class=item><div class=link><a title="Dubbo log" href=/en/projects/sofa-tracer/log-format-dubbo>Dubbo log</a></div></li><li class=item><div class=link><a title="OpenFeign log" href=/en/projects/sofa-tracer/log-format-openfeign>OpenFeign log</a></div></li></ul></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Asynchronous thread processing</h1><a class="edit-button -hidden-mobile" href=https://github.com/sofastack/sofastack.tech/edit/master/content/en/projects/sofa-tracer/async/index.md>Edit</a></div><div class=meta>Update time: 2021-01-20</div></div><article class=typo><h3 id=use-java-lang-runnable-in-thread>Use <code>java.lang.Runnable</code> in thread</h3><p>If you start a thread via <code>java.lang.Runnable</code> in the code or use a thread pool to process some businesses asynchronously, SOFATracer log context needs to be passed from the parent thread to the child thread. <code>com.alipay.common.tracer.core.async.SofaTracerRunnable</code> provided by SOFATracer is reponsible for completing this operation by default. You can use it as follows:</p><pre><code class=language-java>Thread thread = new Thread(new SofaTracerRunnable(new Runnable() {
            @Override
            public void run() {
                //do something your business code
            }
        }));
thread.start();
</code></pre><h3 id=use-java-util-concurrent-callable-in-thread>Use <code>java.util.concurrent.Callable</code> in thread</h3><p>If you start a thread via <code>java.util.concurrent.Callable</code> in the code or use a thread pool to process some businesses asynchronously, SOFATracer log context needs to be passed from the parent thread to the child thread. <code>com.alipay.common.tracer.core.async.SofaTracerCallable</code> provided by SOFATracer is reponsible for completing this operation by default. You can use it as follows:</p><pre><code class=language-java> ExecutorService executor = Executors.newCachedThreadPool();
 SofaTracerCallable&lt;Object&gt; sofaTracerSpanSofaTracerCallable = new SofaTracerCallable&lt;Object&gt;(new Callable&lt;Object&gt;() {
     @Override
     public Object call() throws Exception {
         return new Object();
     }
 });
 Future&lt;Object&gt; futureResult = executor.submit(sofaTracerSpanSofaTracerCallable);
 //do something in current thread
 Thread.sleep(1000);
 //another thread execute success and get result
 Object objectReturn = futureResult.get();
</code></pre><p>This example assumes that the object type returned by <code>java.util.concurrent.Callable</code> is <code>java.lang.Object</code>. You can replace it with the expected type based on actual situation.</p><h3 id=sofatracer-support-for-thread-pool-and-asynchronous-call-scenarios>SOFATracer support for thread pool and asynchronous call scenarios</h3><h4 id=asynchronous>Asynchronous</h4><blockquote><p>Asynchronous invocation, in RPC calls, for example,each time the rpc call request goes out, it will not wait until the result is returned before initiating the next call. There is a time difference here, before the callback of the previous rpc call comes back, another new one begin. At this time, the TracerContext in the current thread is not cleaned up, the spanId will be incremented, and the tracerId is the same.</p></blockquote><p>For the above situation, when the SOFATracer is processed for the asynchronous situation, it will not wait for the callback to execute, and then the cr phase will be cleaned up. Instead, the current thread&rsquo;s tracerContext context will be cleaned up in advance to ensure the correctness of the link.</p><h4 id=thread-pool>Thread Pool</h4><p>For now, whether it&rsquo;s SOFARPC or Dubbo&rsquo;s trace implementation, the situation is the same when using single-thread or thread pools:</p><ul><li>Synchronous call. A thread in the thread pool is allocated to handle the RPC request. This does not cause the next RPC request to take the tracerContext data of the previous request by mistake</li><li>Asynchronous calls, since the asynchronous callback is not in the callback to clean up the context, but in advance, there is no dirty data problem.</li><li>callback, which is essentially an asynchronous call, so the situation is the same as the asynchronous call.</li></ul><p>Attached: <a href=https://github.com/glmapper/sofa-tracer-concurrence-parent>Case Project</a></p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/sofastack>Github</a>
<a class=link href=https://gitee.com/sofastack/>Gitee</a>
<a class=link href=https://github.com/sofastack-guides>Samples</a></div><div class=cate><h2 class=cate-title>Social Media</h2><a class=link href=https://zhuanlan.zhihu.com/sofastack>Zhihu</a>
<a class=link href=https://weibo.com/sofastack>Weibo</a>
<a class=link href=https://twitter.com/sofastack_io>Twitter</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/sofastack/sofastack.tech/issues>Feedback</a>
<a class=link href=https://github.com/sofastack/community>Community</a>
<a class=link href=https://github.com/sofastack/sofastack.tech/wiki>Wiki</a>
<a class=link href=mailto:sofa@alipay.cloud.com>Email</a></div><div class=cate><h2 class=cate-title>Ant Financial Open Source</h2><a class=link href=https://ant.design/>Ant Design</a>
<a class=link href=https://eggjs.org/>Egg</a>
<a class=link href=https://sqlflow.org>SQLFlow</a>
<a class=link href=https://tech.antfin.com/open-source>More</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>DingTalk Group</p></div></div></div><div class=copyright><p>© 2019 - 2020 The SOFAStack Authors
<a href=http://beian.miit.gov.cn/>浙 ICP 备 16045294 号-3</a></p></div></footer></body></html>