<!doctype html><html><head><title>Use API · SOFAStack</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="SOFAStack is a Scalable Open Financial Architecture for building cloud native applications"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=https://gw.alipayobjects.com/os/q/cms/images/jqu9346l/4ba95631-2489-4885-881f-bc7f8d787d5e_w64_h61.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-142131411-1','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome SOFA</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-lookout/use-guide-api/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome SOFA</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-lookout/use-guide-api/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title="SOFALookout is a project that measures and monitors target systems using multi-dimensional metrics.">SOFALookout<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>Main Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-boot/overview>SOFABoot</a></li><li class=item><a href=/en/projects/sofa-rpc/overview>SOFARPC</a></li><li class=item><a href=/en/projects/sofa-tracer/overview>SOFATracer</a></li><li class=item><a href=/en/projects/sofa-lookout/overview>SOFALookout</a></li><li class=item><a href=/en/projects/sofa-registry/overview>SOFARegistry</a></li></ul></div><div class=toc-list><h4 class=title>Incubating Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-mesh/overview>SOFAMesh</a></li><li class=item><a href=/en/projects/sofa-dashboard/overview>SOFADashboard</a></li></ul></div><div class=toc-list><h4 class=title>Tool Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-bolt/overview>SOFABolt</a></li><li class=item><a href=/en/projects/sofa-jraft/overview>SOFAJRaft</a></li><li class=item><a href=/en/projects/sofa-acts/overview>SOFAActs</a></li><li class=item><a href=https://www.sofastack.tech/en/projects/sofa-boot/sofa-ark-readme/>SOFAArk</a></li></ul></div><div class=toc-list><h4 class=title>Ecosystem Projects</h4><ul class=list><li class=item><a href=https://mosn.io/en>MOSN</a></li><li class=item><a href=https://occlum.io>Occlum</a></li><li class=item><a href=https://seata.io>Seata</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title=Overview href=/en/projects/sofa-lookout/overview>Overview</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Quick start guide">Quick start guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Quick start guide for SOFABoot project" href=/en/projects/sofa-lookout/quick-start-client-boot>Quick start guide for SOFABoot project</a></div></li><li class=item><div class=link><a title="Quick start guide for common Java project" href=/en/projects/sofa-lookout/quick-start-client-java>Quick start guide for common Java project</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="User guide">User guide</a></div><ul class=leaf-section><li class=item><div class="link -current"><a title="Use API" href=/en/projects/sofa-lookout/use-guide-api>Use API</a></div></li><li class=item><div class=link><a title="Use Registry" href=/en/projects/sofa-lookout/use-guide-registry>Use Registry</a></div></li><li class=item><div class=link><a title="Project sample" href=/en/projects/sofa-lookout/use-guide-samples>Project sample</a></div></li></ul></li><li class=item><div class=link><a title="Client configuration" href=/en/projects/sofa-lookout/client-configuration>Client configuration</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Existing metrics">Existing metrics</a></div><ul class=leaf-section><li class=item><div class=link><a title="Client built-in extension metrics" href=/en/projects/sofa-lookout/client-ext-metrics>Client built-in extension metrics</a></div></li><li class=item><div class=link><a title="SOFARPC Metrics" href=/en/projects/sofa-lookout/sofarpc-metrics>SOFARPC Metrics</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title=More>More</a></div><ul class=leaf-section><li class=item><div class=link><a title="Development guide" href=/en/projects/sofa-lookout/development-use-guide>Development guide</a></div></li></ul></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Use API</h1><a class="edit-button -hidden-mobile" href=https://github.com/sofastack/sofastack.tech/edit/master/content/en/projects/sofa-lookout/use-guide-api/index.md>Edit</a></div><div class=meta>Update time: 2021-01-20</div></div><article class=typo><h2 id=use-client-api>Use client API</h2><p>In the design of SOFALookout client, API is decoupled from the implementation. If you need to log the events based on the SOFALookout API, you only need to add the <code>lookout-api</code> Maven dependency to the <code>pom.xml</code> file in your application/project. If the dependencies (such as client dependencies or SOFABoot (Spring Boot) Starter) do not exist, the API package uses NoopRegistry automatically, to replace all the locations of which the events are logged.</p><h3 id=1-introduce-api-dependency>1.Introduce API dependency</h3><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa.lookout&lt;/groupId&gt;
    &lt;artifactId&gt;lookout-api&lt;/artifactId&gt;
    &lt;version&gt;${lookout.client.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h3 id=2-about-id>2.About ID</h3><p>Compared to the traditional metrics library&rsquo;s single-dimensional information description, Lookout metrics provides tag capability that supports multi-dimensional descriptions. ID class, the unique identification of Lookout metrics, consists of name and tags.</p><pre><code class=language-java>Id basicId = registry.createId(&quot;rpc.provider.service.stats&quot;);
id = basicId.withTag(&quot;service&quot;, &quot;com.alipay.demo.demoService&quot;)
            .withTag(&quot;method&quot;, &quot;sayHi&quot;)
            .withTag(&quot;protocol&quot;, &quot;tr&quot;)
            .withTag(&quot;alias&quot;, &quot;group1&quot;);
</code></pre><p>The above is a simple example of ID introducing how to create ID and how to tag. Note that every time you tag, a new ID object is generated and returned.</p><blockquote><p>Do not proactively cache Id or the specific Metric object, since Lookout&rsquo;s Registry has already recorded. When using a same Id (with the same name and tags), the existing Id and its corresponding Metric object will be reused.</p></blockquote><h4 id=2-1-priority-tag-optional>2.1 Priority tag (optional)</h4><p>PRIORITY enumeration level: HIGH, NORMAL, LOW.</p><pre><code class=language-java>id.withTag(LookoutConstants.LOW_PRIORITY_TAG);
</code></pre><p>It is recommended that you do not add this tag, the default level will be NORMAL. The level represents the collection interval (HIGH: 2s, NORMAL: 30s, LOW: 1min).</p><h4 id=2-2-about-tags>2.2 About tags</h4><ul><li>General tags, such as local IP, data center, and other details, will be attached and no need to be specified separately.</li><li>In a non-SOFABoot project, you must manually add tags to the client, especially the <code>app</code> tag which specifies the app name: <code>app=appName</code>.</li><li>key contains only lowercase letters, numbers, and underscores.
(especially the metrics at runtime, such as Counter, Timer, and DistributeSummary) The values ​​of a tag shall be within a stable finite set. Try to use as few tags as possible to prevent the number of metrics from exceeding the maximum limit. For example: In RPC service, the value of method&rsquo;s two tags shall be as few as possible.
The counterexample is that each RPC call has a separate tag-value. Therefore, the overall principle is that there should be as few custom tags as possible, and the number of sets of the values ​​should be as small as possible.
Specialized TAG name &ldquo;priority&rdquo; indicates priority.</li><li>The tag key reserved by the system is <code>_*_</code>. Starting with an underscore and ending with an underscore (eg: &ldquo;<em>type</em>&rdquo; ). Do not use this format for keys, since it may be overwritten or discarded by the system.</li></ul><h3 id=3-accessible-statistics-metric-type-api>3. Accessible Statistics (Metric) Type API</h3><h4 id=counter>Counter</h4><ul><li>Scenario: Number of method calls;</li><li>Actively reported data includes: count, rate (namely qps);</li><li>How to use:</li></ul><pre><code class=language-java>Counter counter=registry.counter(id);
counter.inc();
</code></pre><h4 id=timer>Timer</h4><ul><li>Scenario: Statistical tasks, method time-consuming, support bucket statistics</li><li>Actively reported data includes: elapPerExec (single execution time), total time-consuming, Max time-consuming, in seconds;</li><li>How to use:</li></ul><pre><code class=language-java>Timer timer=registry.timer(id);
timer.record(2, TimeUnit.SECONDS);
</code></pre><h4 id=distributionsummary>DistributionSummary</h4><ul><li>Scenario: such as IO traffic, support bucket statistics</li><li>Actively reported data includes: count, total(size), max(size);</li><li>How to use:</li></ul><pre><code class=language-java>DistributionSummary distributionSummary=registry.distributionSummary(id);
distributionSummary.record(1024);
</code></pre><h4 id=gauge-real-time-data-observation>Gauge (real-time data observation)</h4><ul><li>Scenario: Real-time values ​​such as thread pools, memory values.</li><li>Actively reported data includes: value;
When the new gauge is registered in the registry, if the ID values ​​are the same, the registry continues to use the existing ones (ignoring the new ones);</li></ul><blockquote><p>Note: It is recommended that the object observed by gauge is singleton (reuse), and it is always alive during runtime (rather than as a temporary statistic). If it is not singleton or only be alive for some time, then it must be removed from the Registry, otherwise it will affect the GC, and the external object reference it holds cannot be released.</p></blockquote><ul><li>How to use:</li></ul><pre><code class=language-Java>registry.gauge(id,new Gauge&lt;Double&gt;() {
    @Override
    public Double value() {
        return 0.1;
    }
});
</code></pre><h4 id=mixinmetric-the-hybrid-manager-of-the-above-basic-statistics-metrics>MixinMetric (The hybrid manager of the above basic statistics metrics)</h4><p>MixinMetric is unique to Lookout and represents a mixture of multiple basic metrics. The purpose of introducing this Mixin is to optimize the transmission and storage efficiency of multiple metrics indicators for the same metric target (that is, the measurement target is consistent and the tags are consistent). For example: Various indicators of the same thread pool (total number of threads, total active count, waiting queue size).</p><ul><li>How to use: For example, for a service call, add multiple measurement indicators: call time-consuming, input byte count, number of calls, output byte count, etc.</li></ul><pre><code class=language-Java>  //1. getOrAdd MixinMetric
  MixinMetric rpcServiceMetric=registry.minxinMetric(id);

  //2. getOrAdd basic component metric to use
  Timer rpcTimer = rpcServiceMetric.timer(&quot;perf&quot;);
  DistributionSummary rpcOutSizeMetric = rpcServiceMetric.distributionSummary(&quot;inputSize&quot;);
</code></pre><h4 id=top-tools>Top Tools</h4><ul><li>Scenario: List the metrics information of TOP 5/10/20;</li><li>Background: When you want to track and measure more finely, such as the request time-consuming of a SQL statement (an URL), you may need to use SQL (or URL) as a tag, such as:</li></ul><pre><code class=language-Java>Sql_execute_cost:sql=select..
Sql_execute_cost:sql=insert..
Sql_execute_cost: sql=insert2..
...
</code></pre><p>The resulting metrics will be too much. The upper limit of the total number of metrics (to avoid affecting the business) is generally at around 5000. So it is recommended to have as few tags as possible, and each tag values ​​should be enumerated as much as possible, and the number should be as small as possible.</p><p>But if you really want to target some fine-grained problems, then it is recommended to use TopUtil (it can only record the first few data and eliminate other data).</p><ul><li>How to use:</li></ul><pre><code class=language-Java>TopGauger topGauger = TopUtil.topGauger(registry, registry.createId(&quot;top5sql&quot;), 5);

topGauger.record(1000l, new BasicTag(&quot;sql1&quot;, &quot;select1&quot;));
topGauger.record(2000l, new BasicTag(&quot;sql2&quot;, &quot;select2&quot;));
...
</code></pre></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/sofastack>Github</a>
<a class=link href=https://gitee.com/sofastack/>Gitee</a>
<a class=link href=https://github.com/sofastack-guides>Samples</a></div><div class=cate><h2 class=cate-title>Social Media</h2><a class=link href=https://zhuanlan.zhihu.com/sofastack>Zhihu</a>
<a class=link href=https://weibo.com/sofastack>Weibo</a>
<a class=link href=https://twitter.com/sofastack_io>Twitter</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/sofastack/sofastack.tech/issues>Feedback</a>
<a class=link href=https://github.com/sofastack/community>Community</a>
<a class=link href=https://github.com/sofastack/sofastack.tech/wiki>Wiki</a>
<a class=link href=mailto:sofa@alipay.cloud.com>Email</a></div><div class=cate><h2 class=cate-title>Ant Financial Open Source</h2><a class=link href=https://ant.design/>Ant Design</a>
<a class=link href=https://eggjs.org/>Egg</a>
<a class=link href=https://sqlflow.org>SQLFlow</a>
<a class=link href=https://tech.antfin.com/open-source>More</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>DingTalk Group</p></div></div></div><div class=copyright><p>© 2019 - 2020 The SOFAStack Authors
<a href=http://beian.miit.gov.cn/>浙 ICP 备 16045294 号-3</a></p></div></footer></body></html>