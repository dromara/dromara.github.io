<!doctype html><html><head><title>Ark container class loading mechanism · SOFAStack</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="SOFAStack is a Scalable Open Financial Architecture for building cloud native applications"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=https://gw.alipayobjects.com/os/q/cms/images/jqu9346l/4ba95631-2489-4885-881f-bc7f8d787d5e_w64_h61.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-142131411-1','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome SOFA</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-boot/sofa-ark-classloader/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome SOFA</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-boot/sofa-ark-classloader/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"><div id=js-drawer class=ss-toc><div id=js-drawer-handle class=drawer-handle><svg class="icon icon-menu" aria-hidden="true"><use xlink:href="#icon-menu"/></svg><svg class="icon icon-close" aria-hidden="true"><use xlink:href="#icon-close"/></svg></div><div class=drawer-body><div class=header title="SOFABoot is a development framework based on Spring Boot, provides capabilities such as Readiness Check, class isolation, log space isolation and asynchronous initialization of bean.">SOFABoot<div class="ss-toc-list-card -hidden-mobile"><svg class="icon -hidden-mobile" aria-hidden="true"><use xlink:href="#icon-menu1"/></svg><div class=ss-tooltip><div class=toc-list><h4 class=title>Main Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-boot/overview>SOFABoot</a></li><li class=item><a href=/en/projects/sofa-rpc/overview>SOFARPC</a></li><li class=item><a href=/en/projects/sofa-tracer/overview>SOFATracer</a></li><li class=item><a href=/en/projects/sofa-lookout/overview>SOFALookout</a></li><li class=item><a href=/en/projects/sofa-registry/overview>SOFARegistry</a></li></ul></div><div class=toc-list><h4 class=title>Incubating Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-mesh/overview>SOFAMesh</a></li><li class=item><a href=/en/projects/sofa-dashboard/overview>SOFADashboard</a></li></ul></div><div class=toc-list><h4 class=title>Tool Projects</h4><ul class=list><li class=item><a href=/en/projects/sofa-bolt/overview>SOFABolt</a></li><li class=item><a href=/en/projects/sofa-jraft/overview>SOFAJRaft</a></li><li class=item><a href=/en/projects/sofa-acts/overview>SOFAActs</a></li><li class=item><a href=https://www.sofastack.tech/en/projects/sofa-boot/sofa-ark-readme/>SOFAArk</a></li></ul></div><div class=toc-list><h4 class=title>Ecosystem Projects</h4><ul class=list><li class=item><a href=https://mosn.io/en>MOSN</a></li><li class=item><a href=https://occlum.io>Occlum</a></li><li class=item><a href=https://seata.io>Seata</a></li></ul></div></div></div></div><div class=body><ul class=leaf-section><li class=item><div class=link><a title="SOFABoot overview" href=/en/projects/sofa-boot/overview>SOFABoot overview</a></div></li><li class=item><div class=link><a title="Quick start guide" href=/en/projects/sofa-boot/quick-start>Quick start guide</a></div></li><li class=item><div class=link><a title="Dependency management" href=/en/projects/sofa-boot/dependency-management>Dependency management</a></div></li><li class=item><div class=link><a title="Health check" href=/en/projects/sofa-boot/health-check>Health check</a></div></li><li class=item><div class=link><a title="View version" href=/en/projects/sofa-boot/view-versions>View version</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Module isolation">Module isolation</a></div><ul class=leaf-section><li class=item><div class=link><a title="Modular development" href=/en/projects/sofa-boot/modular-development>Modular development</a></div></li><li class=item><div class=link><a title="Module configuration" href=/en/projects/sofa-boot/sofaboot-module>Module configuration</a></div></li><li class=item><div class=link><a title="Publish and reference JVM services" href=/en/projects/sofa-boot/module-service>Publish and reference JVM services</a></div></li><li class=item><div class=link><a title="Module parallel startup" href=/en/projects/sofa-boot/parallel-start>Module parallel startup</a></div></li><li class=item><div class=link><a title="SOFABoot profile" href=/en/projects/sofa-boot/sofaboot-profile>SOFABoot profile</a></div></li><li class=item><div class=link><a title="SOFABoot extension point" href=/en/projects/sofa-boot/extension>SOFABoot extension point</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Class Isolation">Class Isolation</a></div><ul class=leaf-section><li class=item><div class=link><a title="Introduction to SOFAArk" href=/en/projects/sofa-boot/sofa-ark-readme>Introduction to SOFAArk</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Quick start guide">Quick start guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Package into Ark Plugin" href=/en/projects/sofa-boot/sofa-ark-ark-plugin-demo>Package into Ark Plugin</a></div></li><li class=item><div class=link><a title="Package into Ark JAR" href=/en/projects/sofa-boot/sofa-ark-ark-demo>Package into Ark JAR</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="User guide">User guide</a></div><ul class=leaf-section><li class=item><div class=link><a title=Terminologies href=/en/projects/sofa-boot/sofa-ark-terminology>Terminologies</a></div></li><li class=item><div class=link><a title="Ark JAR package" href=/en/projects/sofa-boot/sofa-ark-ark-jar>Ark JAR package</a></div></li><li class=item><div class=link><a title="Ark Plugin" href=/en/projects/sofa-boot/sofa-ark-ark-plugin>Ark Plugin</a></div></li><li class=item><div class=link><a title="Ark Biz" href=/en/projects/sofa-boot/sofa-ark-ark-biz>Ark Biz</a></div></li><li class=item><div class=link><a title="Use class isolation in SOFABoot" href=/en/projects/sofa-boot/classloader-isolation>Use class isolation in SOFABoot</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Developer guide">Developer guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Ark container startup process" href=/en/projects/sofa-boot/sofa-ark-startup>Ark container startup process</a></div></li><li class=item><div class=link><a title="Ark container plugin mechanism" href=/en/projects/sofa-boot/sofa-ark-plugin>Ark container plugin mechanism</a></div></li><li class=item><div class="link -current"><a title="Ark container class loading mechanism" href=/en/projects/sofa-boot/sofa-ark-classloader>Ark container class loading mechanism</a></div></li></ul></li><li class=item><div class=link><a title="Release notes" href=/en/projects/sofa-boot/sofa-ark-release>Release notes</a></div></li><li class=item><div class=link><a title=Roadmap href=/en/projects/sofa-boot/sofa-ark-roadmap>Roadmap</a></div></li><li class=item><div class=link><a title=Contribution href=/en/projects/sofa-boot/sofa-ark-contribution>Contribution</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Dynamic deployment">Dynamic deployment</a></div><ul class=leaf-section><li class=item><div class=link><a title="Introduction to Jarslink" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-readme>Introduction to Jarslink</a></div></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Quick start guide">Quick start guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Create a SOFABoot application" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-app-demo>Create a SOFABoot application</a></div></li><li class=item><div class=link><a title="Use Jarslink for multi-application dynamic deployment" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-deploy-demo>Use Jarslink for multi-application dynamic deployment</a></div></li><li class=item><div class=link><a title="Communicate across applications" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-invocation-demo>Communicate across applications</a></div></li><li class=item><div class=link><a title="Integrate SOFABoot health check" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-health-demo>Integrate SOFABoot health check</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="User guide">User guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Application packaging" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-repackage>Application packaging</a></div></li><li class=item><div class=link><a title="Merged deployment" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-deploy>Merged deployment</a></div></li><li class=item><div class=link><a title="Interactive instruction" href=/en/projects/sofa-boot/sofa-jarslink-jarslink-instruction>Interactive instruction</a></div></li><li class=item><div class=link><a title=Lifecycle href=/en/projects/sofa-boot/sofa-jarslink-jarslink-lifecycle>Lifecycle</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Developer guide">Developer guide</a></div><ul class=leaf-section><li class=item><div class=link><a title="Compile Jarslink project" href=/en/projects/sofa-boot/sofa-jarslink-compile>Compile Jarslink project</a></div></li><li class=item><div class=link><a title=Architecture href=/en/projects/sofa-boot/sofa-jarslink-structure>Architecture</a></div></li><li class=item><div class=link><a title="Basic model" href=/en/projects/sofa-boot/sofa-jarslink-model>Basic model</a></div></li><li class=item><div class=link><a title="Version release" href=/en/projects/sofa-boot/sofa-jarslink-version>Version release</a></div></li></ul></li><li class=item><div class=link><a title="Release notes" href=/en/projects/sofa-boot/sofa-jarslink-release>Release notes</a></div></li><li class=item><div class=link><a title=Roadmap href=/en/projects/sofa-boot/sofa-jarslink-roadmap>Roadmap</a></div></li><li class=item><div class=link><a title=Contribution href=/en/projects/sofa-boot/sofa-jarslink-contribution>Contribution</a></div></li></ul></li><li class=item><div class=link><svg class="icon arrow" aria-hidden="true"><use xlink:href="#icon-arrow"/></svg><a title="Documentation for upgrade">Documentation for upgrade</a></div><ul class=leaf-section><li class=item><div class=link><a title="SOFABoot 2.5.x upgrade" href=/en/projects/sofa-boot/upgrade_2_5_x>SOFABoot 2.5.x upgrade</a></div></li><li class=item><div class=link><a title="SOFABoot 3.0 upgrade" href=/en/projects/sofa-boot/upgrade_3_x>SOFABoot 3.0 upgrade</a></div></li></ul></li></ul></div></div></div></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Ark container class loading mechanism</h1><a class="edit-button -hidden-mobile" href=https://github.com/sofastack/sofastack.tech/edit/master/content/en/projects/sofa-boot/sofa-ark-classloader/index.md>Edit</a></div><div class=meta>Update time: 2021-01-20</div></div><article class=typo><h1 id=ark-container-class-loading-mechanism>Ark container class loading mechanism</h1><p>The plugins and business modules are managed in the Ark container. The following figure describes the class loading mechanism:</p><p><img src=https://gw.alipayobjects.com/zos/skylark/7dfdc66f-a70d-4ef0-9de3-92b72bf2caf7/2018/png/77f10035-a6c3-4bab-bff3-a2c9a986561f.png alt=undefined></p><h2 id=class-loading-mechanism-of-ark-container>Class loading mechanism of Ark container</h2><p>Each Ark plugin has a separate classloader which loads a class in the following order:</p><ol><li>If byte codes generated by reflection are loaded, the system will throw a ClassNotFoundException to terminate the loading process. This primarily comes from our engineering practice: to avoid long time searches for the classes that can never be found.</li><li>Search for the already loaded classes</li><li>Search for classes in the JDK, which mainly consists of two parts: 1) the classes to be loaded by ExtClassloader; 2) the classes that are provided by the JDK but fail to be loaded from the ExtClassloader. When running locally, however, these classes will be added to the SystemClassloader&rsquo;s classpath or they might be put into some third-party toolkits such as <code>sun.tools.attach.BsdVirtualMachine</code> in tool.jar at the same time. This part also comes from our engineering practice, avoiding errors caused by loading a class more than once.</li><li>See if the class is an interface from Sofa Ark, such as <code>com.alipay.sofa.Ark.spi.service.PluginActivator</code>. If so, the class will be delegated to the classloader of the Ark container responsible for loading.</li><li>See if it is located in the plugin import (including import-classes and import-package). If so, the loading will be delegated to the plugin classloader that will export it.</li><li>Load in the plugin&rsquo;s own classpath</li><li>If the above steps have failed, it will try to load the class in SymtemClassloader to deal with the situation that the agent is used.</li></ol><p>If the class fails to be loaded with all the above steps, the ClassNotFoundException will be thrown.</p><h2 id=ark-business-class-loading-mechanism>Ark business class loading mechanism</h2><p>Each Ark business has a separate classloader. Its class loading mechanism is basically consistent with that of Ark plugin, except for the step 5:</p><p>For Ark business, no import configuration is provided. Instead, it defaults to importing all classes exported by plug-ins. To deal with some particular business scenarios, however, we do provide the Deny-import configuration so that we can exclude the classes exported by some plugins.</p><h1 id=class-loading-mechanism-of-ark-plugin-resources>Class loading mechanism of Ark plugin resources</h1><p>The Ark plugin supports importing and exporting resources. To achieve this, we need to configure the corresponding import and export settings in <code>sofa-Ark-plugin-maven-plugin</code>. There are two ways to search for resources when using ClassLoader: <code>ClassLoader.getResource(String)</code> or <code>ClassLoader.getResources(String)</code>;</p><ul><li><p><code>ClassLoader.getResource(String)</code>: When an Ark Plugin is searching for a single resource, it will delegate the Ark Plugin that will export the resource to load the class first. If multiple plugins export the resource at the same time, then the plugin with higher priority will export the resource first. If the loading fails or no other Ark Plugin has exported the resource, it will have a try from the current Ark Plugin;</p></li><li><p><code>ClassLoader.getResources(String)</code>: When the Ark Plugin is searching for multiple resources, it will load from all Ark Plugins that export the resources as well as from the current Ark Plugin;</p></li></ul><h1 id=ark-business-resource-loading-mechanism>Ark business resource loading mechanism</h1><p>The Ark Biz will first load the resources exported by Ark Plugin by default. If developers want to search within the project, they can configure <code>denyImportResources</code> in <code>sofa-Ark-maven-plugin</code>. In this way, the Ark Biz will search for the resources inside Ark Biz rather than Ark Plugin.</p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/sofastack>Github</a>
<a class=link href=https://gitee.com/sofastack/>Gitee</a>
<a class=link href=https://github.com/sofastack-guides>Samples</a></div><div class=cate><h2 class=cate-title>Social Media</h2><a class=link href=https://zhuanlan.zhihu.com/sofastack>Zhihu</a>
<a class=link href=https://weibo.com/sofastack>Weibo</a>
<a class=link href=https://twitter.com/sofastack_io>Twitter</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/sofastack/sofastack.tech/issues>Feedback</a>
<a class=link href=https://github.com/sofastack/community>Community</a>
<a class=link href=https://github.com/sofastack/sofastack.tech/wiki>Wiki</a>
<a class=link href=mailto:sofa@alipay.cloud.com>Email</a></div><div class=cate><h2 class=cate-title>Ant Financial Open Source</h2><a class=link href=https://ant.design/>Ant Design</a>
<a class=link href=https://eggjs.org/>Egg</a>
<a class=link href=https://sqlflow.org>SQLFlow</a>
<a class=link href=https://tech.antfin.com/open-source>More</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>DingTalk Group</p></div></div></div><div class=copyright><p>© 2019 - 2020 The SOFAStack Authors
<a href=http://beian.miit.gov.cn/>浙 ICP 备 16045294 号-3</a></p></div></footer></body></html>